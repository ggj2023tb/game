
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="homepage">
    <meta name="author" content="">
    <link rel="icon" href="img/favicon.ico">
    <title>QRoots</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/game.css" rel="stylesheet" />
  </head>
  <body>
    <div id="content">
        <div class="container-fluid text-center">
            <img class="mb-4" src="img/logo.png" style="width: 200px; height: 200px;" />
            <h3 class="mb-3 font-weight-normal">QRoots</h3>
            <br />
            <h1 class="mb-3">Do you even Roots ?</h1>
            <div class="row">
                <div class="offset-lg-5 col-lg-2">
                    <form id="homeForm" method="post">
                        <input type="text" class="form-control" id="username" required placeholder="Enter your name ..." />
                        <br />
                        <button type="submit" class="btn btn-success form-control">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
  </body>
  <script>
    let socket;
    if (location.hostname === 'localhost') {
        socket = new WebSocket('ws://localhost:9000');
    } else {
        socket = new WebSocket('ws://195.201.251.92:9000');
    }
    let playerName;
    let roomId;
    let inGame = false;
    let playerId;
    let currentQuestion = null;

    $(document).ready(function(){
        $(document).on('submit', '#homeForm', function(event){
            event.preventDefault();
            playerName = $("#username").val();
            $('#content').load('stages/menu.html');
        }).on('click', '#createGameStage', function(event){
            $('#content').load('stages/create-game.html');
        }).on('click', '#joinRoomStage', function(event){
            $('#content').load('stages/join-room.html');
            setInterval(function () {
                socket.send(JSON.stringify({ "type": "getRooms" }));
            }, 3000);
        }).on('submit', '#createGameForm', function(event){
            event.preventDefault();
            socket.send(JSON.stringify({ "type": "createGame", "name": $('#roomName').val() }));
        }).on('click', '#startGame', function(){
            socket.send(JSON.stringify({ "type": "startGame", "roomId": roomId }));
        }).on('click', '#joinOpenRoom', function(){
            roomId = $(this).data("roomId");
            socket.send(JSON.stringify({ "type": "joinRoom", "roomId": roomId, "playerName": playerName }));
        }).on('click', '.awnserButton', function(){
            $('.awnserButton').prop('disabled', true);
            socket.send(JSON.stringify({ "type": "awnser", "roomId": roomId, "playerId": playerId, "question": $(this).data('question'), "answer": $(this).data('answer') }));
        })
    });

    socket.addEventListener('message', (event) => {
        data = JSON.parse(event.data);

        if (data.type == 'createGame') {
            roomId = data.roomId;
            socket.send(JSON.stringify({ "type": "joinRoom", "roomId": roomId, "playerName": playerName }));
        }

        if (data.type == 'joinRoom') {
            roomId = data.roomId;
            playerId = data.playerId;
            $('#content').load('stages/lobby.html');
            setInterval(function () {
                socket.send(JSON.stringify({ "type": "updateGame", "roomId": roomId }));
            }, 1000);
        }

        if (data.type == 'getRooms') {
            console.log(data.rooms);
            /*
             * loop over rooms and create html for rooms with status == "open"
             * $('xyz').html(generateHTML). add room.roomId as "data-roomId"
             */
            let openRoomsCards = ''; 
            data.rooms.forEach(function(room, index){
                if (room.status == 'open') {
                    console.log(room.id );
                    openRoomsCards += '<div class="room-card col-md-4"><div class="room-content"><h4 class="title"> Room #'+ room.id +'</h4></div><ul class="join"><button type="button"  class="btn btn-success" id="joinOpenRoom" data-roomId = '+ room.id +' > Join !</button></ul></div>';
                }
            });
            $('.container-room-card .row').html(openRoomsCards);
        };

        if (data.type == 'updateGame') {
            if (!inGame && data.room.status == 'running') {
                $('#content').load('stages/game.html', function () {
                    inGame = true;

                    data.room.players.forEach(function (player, index) {
                        $('.canvas').append('<div class="tree" style="padding-right: 250px;"><div class="trunk trunk_'+player.id+'" data-points="0"></div></div>');
                    });
                });
            }

            if (inGame) {
                let currentTime = Date.now();

                data.room.questions.forEach(function (question, index) {
                    if (currentTime >= question.startDate && currentTime <= question.endDate) {
                        if (currentQuestion == null || (currentQuestion.question.question !== question.question.question)) {
                            currentQuestion = question;
                            $('#question').html('<h2>' + question.question.question + '</h2>');
                            let html = '';
                            html += '<input class="awnserButton btn btn-primary m-2" data-question="' + question.question.question + '" data-answer="option_0" type="button" value="' + question.question['option_0'] + '"/>';
                            html += '<input class="awnserButton btn btn-primary m-2" data-question="' + question.question.question + '" data-answer="option_1" type="button" value="' + question.question['option_1'] + '"/>';
                            html += '<input class="awnserButton btn btn-primary m-2" data-question="' + question.question.question + '" data-answer="option_2" type="button" value="' + question.question['option_2'] + '"/>';
                            html += '<input class="awnserButton btn btn-primary m-2" data-question="' + question.question.question + '" data-answer="option_3" type="button" value="' + question.question['option_3'] + '"/>';
                            $('#answers').html(html);
                        }
                    }
                });

                if (currentQuestion) {
                    timer = Math.ceil((currentQuestion.endDate - currentTime) / 1000);

                    if (timer >= 0) {
                        $('#timer').html(timer);
                    }
                }

                data.room.players.forEach(function (player, index) {
                    if ($('.trunk_'+player.id).data('points') < player.points) {
                        $('.trunk_'+player.id).append('<div class="branch"><div class="leaf"></div><div class="leaf"></div><div class="leaf"></div><div class="leaf"></div><div class="leaf"></div></div>');
                        $('.trunk_'+player.id).data('points', player.points);
                    }
                });
            }
        }
    });
  </script>
</html>
